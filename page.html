<html>
<head>
<title>Iris User Editor</title>
<script src="/static/jquery.min.js" type="text/javascript"></script>
<script src="/static/handlebars.min.js" type="text/javascript"></script>
<script src="/static/navigo.min.js" type="text/javascript"></script>
<link href="/static/lumen.min.css" type="text/css" rel="stylesheet">
<style>
#wrap {
  width: 500px;
  margin: auto;
}
#flashes {
  margin-top: 15px;
}
</style>
<script>
  function get_users(startat, startswith, callback) {
    var getload = {};
    if (startat) {
      getload.startat = startat;
    }
    if (startswith) {
      getload.startswith = startswith;
    }
    $.get('/api/users', getload, callback);
  }

  function get_user(username, callback) {
    $.get('/api/users/' + username, callback);
  }

  function edit_user(username, info, callback) {
    $.ajax({
          url: '/api/users/' + username,
          data: JSON.stringify(info),
          method: 'PUT',
          contentType: 'application/json'
    }).done(callback);
  }

  function delete_user(username, callback) {
    $.ajax({
          url: '/api/users/' + username,
          data: '{}',
          method: 'DELETE',
          contentType: 'application/json'
    }).done(callback);
  }

  function create_user(username, callback) {
    $.ajax({
          url: '/api/users/',
          data: JSON.stringify({username: username}),
          method: 'POST',
          contentType: 'application/json'
    }).done(callback);
  }

  $(function() {
    Handlebars.registerHelper('booltostr', function(str) {
      return str ? 'Yes' : 'no';
    });

    var user_lister = Handlebars.compile($('#user-lister-template').html()),
        user_viewer = Handlebars.compile($('#user-viewer-template').html()),
        user_editor = Handlebars.compile($('#user-editor-template').html()),
        user_create = Handlebars.compile($('#user-create-template').html()),
        flash_template = Handlebars.compile($('#flash-template').html()),
        user_pagination_interval = 100,
        $content = $('#content'),
        $flashes = $('#flashes'),
        $title = $('h1'),
        router = new Navigo(null, false, '#!'),
        last_flash = null;

    function flash(type, message) {
      last_flash = {type: type, message: message};
    }

    function render_page(title, contents) {
      $title.text(title);
      $content.html(contents);
      router.updatePageLinks();
      if (last_flash) {
        $flashes.html(flash_template(last_flash));
        last_flash = null;
      } else {
        $flashes.empty();
        last_flash = null;
      }
    };

    $content.on('submit', '#user-edit', function(e){
      e.preventDefault();
      var $save_user_button = $('#save-user'),
          username = $save_user_button.data('user');

      $save_user_button.prop('disabled', 'true');

      var contacts = {};
      $('#user-edit').find('input[type=text]').each(function() {
        var $this = $(this), mode = $this.data('mode'), val = $(this).val();
        contacts[mode] = val;
      });

      var info = {
        contacts: contacts,
        admin: $('#admin').prop('checked'),
        active: $('#active').prop('checked')
      };

      edit_user(username, info, function(){
        flash('info', 'Updated ' + username);
        router.navigate('/user/' + username);
      });
    });

    $content.on('submit', '#user-create', function(e){
      e.preventDefault();
      var username = $('#username').val();
      if (username == '') {
        return;
      }
      create_user(username, function() {
        flash('info', 'Created ' + username);
        router.navigate('/user/' + username);
      });
    });

    $content.on('click', '#delete-user', function(e){
      e.preventDefault();
      if (!confirm('Really delete?')) {
        return;
      }
      var username = $(this).data('user');
      delete_user(username, function() {
        flash('info', 'Deleted ' + username);
        router.navigate('/');
      });
    });

    $content.on('submit', '#username-search', function(e){
      e.preventDefault();
      var startswith = $('#username-search-box').val();
      if (startswith == '') {
        router.navigate('/');
      } else {
        router.navigate('/users/startat/0/startswith/' + encodeURIComponent(startswith));
      }
    });

    function users_list_page(params) {
      var startat = params.startat ? params.startat : 0;
      var startswith = params.startswith ? decodeURIComponent(params.startswith) : '';
      get_users(startat, params.startswith ? params.startswith : null, function(data) {
        var next = '/users/startat/' + (parseInt(startat) + user_pagination_interval);
        var prev = '/users/startat/' + (parseInt(startat) - user_pagination_interval);

        if (startat <= user_pagination_interval) {
            prev = '/users/startat/0';
        }

        if (startswith != '') {
            next = next + '/startswith/' + startswith;
            prev = prev + '/startswith/' + startswith;
        }

        render_page('Users List', user_lister({users: data, next: next, prev: prev, startswith: startswith}));
      });
    }

    router.on({
      '/': users_list_page,
      '/users/startat/:startat': users_list_page,
      '/users/startat/:startat/startswith/:startswith': users_list_page,

      '/user/:username': function (params) {
        get_user(params.username, function(data) {
          render_page(params.username, user_viewer({user: params.username, info: data}));
        });
      },

      '/user/:username/edit': function (params) {
        get_user(params.username, function(data) {
          render_page(params.username, user_editor({user: params.username, info: data}));
        });
      },

      '/user_create': function () {
        render_page('Create', user_create());
      },
    }).resolve();
  });
</script>
</head>
<body>

<div id="wrap">
  <div id="flashes"></div>
  <h1></h1>
  <ul class="nav nav-tabs">
    <li><a data-navigo href="/" data-toggle="tab" aria-expanded="true">User List</a></li>
    <li><a data-navigo href="/user_create" data-toggle="tab" aria-expanded="true">User Create</a></li>
  </ul>
  <div id="content"></div>
</div>

<script id="user-lister-template" type="text/x-handlebars-template">
  <ul class="pager">
    {{#if prev }}
      <li class="previous"><a href="{{prev}}" data-navigo>&larr; Prev</a></li>
    {{else}}
      <li class="previous"><a href="/" class="disabled"  data-navigo>&larr; Prev</a></li>
    {{/if}}
    {{#if next }}
      <li class="next"><a href="{{next}}" data-navigo>Next &rarr;</a></li>
    {{else}}
      <li class="next"><a href="/"  class="disabled"  data-navigo>Next &rarr;</a></li>
    {{/if}}
  </ul>

  <form id="username-search">User search: <input type="text" placeholder="Username" id="username-search-box" value="{{startswith}}"></form>

  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Name</th>
        <th>Active</th>
        <th>Admin</th>
      </tr>
    </thead>
    <tbody>
      {{#each users}}
      <tr>
        <td><a data-navigo href="/user/{{name}}">{{name}}</a></td>
        <td>{{booltostr active}}</td>
        <td>{{booltostr admin}}</td>
      </tr>
      {{/each}}
    </tbody>
  </table>
</script>

<script id="user-viewer-template" type="text/x-handlebars-template">
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Contact</th>
        <th>Destination</th>
      </tr>
    </thead>
    <tbody>
      {{#each info.contacts}}
      <tr>
        <td>{{@key}}</td>
        <td>{{this}}</td>
      </tr>
      {{/each}}
    </tbody>
  </table>
  Admin: <input disabled type="checkbox" id="admin"{{#if info.admin}}checked{{/if}}><br>
  Active: <input disabled type="checkbox" id="active"{{#if info.active}}checked{{/if}}><br>
  <a href="/" class="btn btn-default" data-navigo>Back</a>
  <a href="/user/{{user}}/edit" class="btn btn-primary" data-navigo>Edit</a>
</script>

<script id="user-editor-template" type="text/x-handlebars-template">
  <form id="user-edit">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Contact</th>
          <th>Destination</th>
        </tr>
      </thead>
      <tbody>
        {{#each info.contacts}}
        <tr>
          <td>{{@key}}</td>
          <td><input type="text" data-mode="{{@key}}" value="{{this}}"></td>
        </tr>
        {{/each}}
      </tbody>
    </table>

    Admin: <input type="checkbox" id="admin"{{#if info.admin}}checked{{/if}}><br>
    Active: <input type="checkbox" id="active"{{#if info.active}}checked{{/if}}><br>

    <a class="btn btn-default" href="/user/{{user}}">Back</a>
    <button class="btn btn-primary" data-user="{{user}}" id="save-user">Save</button>
    <a class="btn btn-danger" data-user="{{user}}" id="delete-user">Delete</a>
  </form>
</script>

<script id="user-create-template" type="text/x-handlebars-template">
<form id="user-create" class="form-horizontal" style="margin-top: 20px;">
  <fieldset>
    <div class="form-group">
      <label for="username" class="col-lg-2 control-label">Username</label>
      <div class="col-lg-10">
        <input data-field="username" type="text" class="form-control" id="username" placeholder="username">
      </div>
    </div>
    <div class="form-group">
        <div class="col-lg-10 col-lg-offset-2">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
    </div>
  </fieldset>
</form>
</script>

<script id="flash-template" type="text/x-handlebars-template">
  <div class="alert alert-dismissible alert-{{type}}">
    {{message}}
  </div>
</script>

</body>
</html>
